<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GOR Insulin Infusion Calculator (Proof-of-Concept WIP)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    /* ✅ ALIGNMENT FIX: prevent padding/border from causing overflow on all devices */
    *, *::before, *::after { box-sizing: border-box; }

    body { margin: 0; padding: 16px; background: #f6f7f9; }
    .card { max-width: 780px; margin: 0 auto; background: #fff; border-radius: 14px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.06); }
    h1 { font-size: 18px; margin: 0 0 8px; }
    .sub { font-size: 12px; color: #555; margin: 0 0 14px; line-height: 1.4; }
    label { display: block; font-size: 12px; color: #333; margin: 12px 0 6px; }

    /* ✅ ALIGNMENT FIX: keep fields inside grid columns, consistent height */
    input, select {
      width: 100%;
      max-width: 100%;
      padding: 10px;
      border: 1px solid #d7dbe0;
      border-radius: 10px;
      font-size: 16px;
      height: 44px;
      line-height: 22px;
    }

    .grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 640px) { .grid.two { grid-template-columns: 1fr 1fr; } }

    .row { display:flex; gap:10px; align-items:center; margin-top:10px; }
    .row input[type="checkbox"]{ width:auto; transform: scale(1.15); height:auto; }

    button { width: 100%; margin-top: 14px; padding: 12px; border: 0; border-radius: 12px; font-size: 16px; cursor: pointer; }
    button.primary { background: #111827; color: #fff; }
    button.ghost { background: #eef2ff; }
    .out { margin-top: 14px; padding: 12px; border-radius: 12px; background: #f3f4f6; }
    .out p { margin: 6px 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .small { font-size: 12px; color: #444; }
    .warn { font-size: 12px; color: #7c2d12; background: #fff7ed; border: 1px solid #fed7aa; padding: 10px; border-radius: 12px; margin-top: 12px; }
    .pill { display:inline-block; padding:2px 8px; border-radius: 999px; background:#e5e7eb; font-size:12px; }

    /* big-drop warning */
    .danger { color:#b91c1c; font-weight:700; }
    .dangerBox {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      color:#7f1d1d;
      font-size: 12px;
      line-height: 1.35;
    }
    /* ===== Reference Table ===== */

.referenceSection {
  margin-top: 18px;
  padding-top: 10px;
  border-top: 1px solid #e5e7eb;
}

.tableWrap {
  width: 100%;
  overflow-x: auto;   /* makes mobile scroll instead of breaking layout */
}

.refTable {
  width: 100%;
  min-width: 700px;   /* forces horizontal scroll on phones */
  border-collapse: collapse;
  font-size: 12px;
}

.refTable th,
.refTable td {
  border: 1px solid #e5e7eb;
  padding: 6px 8px;
  text-align: center;
  white-space: nowrap;
}

.refTable th {
  background: #f3f4f6;
  font-weight: 600;
}

.referenceNote {
  margin-top: 8px;
  font-size: 12px;
  color: #555;
}

  </style>
</head>

<body>
  <div class="card">
    <h1>GOR Insulin Infusion Calculator (Proof of Concept WIP)</h1>
    <p class="sub">
      Based off institutional policy rev. 2026. No data stored. Please refer to the policy guideline for the most up to date information and for data
    </p>

    <label for="scale">Current infusion scale</label>
    <select id="scale">
      <option value="A">Scale A</option>
      <option value="B">Scale B</option>
      <option value="C">Scale C</option>
    </select>

    <div class="grid two">
      <div>
        <label for="rate">Current infusion rate (U/hr)</label>
        <input id="rate" inputmode="decimal" placeholder="e.g., 6.0" />
      </div>
      <div>
        <label for="prev">Previous BG (mg/dL)</label>
        <input id="prev" inputmode="numeric" placeholder="e.g., 145" />
      </div>
    </div>

    <label for="curr">Current BG (mg/dL)</label>
    <input id="curr" inputmode="numeric" placeholder="e.g., 210" />

    <div class="row">
      <input id="sameScale" type="checkbox" checked />
      <label for="sameScale" style="margin:0;">
        Same scale since last BG check (needed so calculator can check for BG >150 x2 automatically)
      </label>
    </div>

    <button class="primary" id="calc" type="button">Calculate recommendation</button>
    <button class="ghost" id="reset" type="button">Reset</button>

    <div class="warn">
      Disclaimer: Decision support only. Just a tool not meant to replace clinical judgement or decision making, please consult the policy for the most up to date and correct info :)
      <span class="pill">Version v0.4</span>
    </div>

    <div class="out" id="out" style="display:none;"></div>
  </div>

<script>
(() => {
  // ========= SCALES TABLE =========
  const TABLE = {
    A: [
      [80,  99,  0],
      [100, 104, 1],
      [105, 121, 2],
      [122, 138, 3],
      [139, 154, 4],
      [155, 171, 5],
      [172, 188, 6],
      [189, 204, 7],
      [205, 221, 8],
      [222, 238, 9],
      [239, 254, 10],
      [255, 271, 11],
      [272, 288, 12],
      [289, 304, 13],
      [305, 321, 14],
      [322, 338, 15],
      [339, 354, 16],
      [355, 371, 17],
      [372, 388, 18],
      [389, 399, 19],
    ],
    B: [
      [80,  99,  0],
      [387, 390, 25],
      [374, 386, 24],
      [362, 373, 23],
      [349, 361, 22],
      [337, 348, 21],
      [324, 336, 20],
      [312, 323, 19],
      [299, 311, 18],
      [287, 298, 17],
      [274, 286, 16],
      [262, 273, 15],
      [249, 261, 14],
      [237, 248, 13],
      [224, 236, 12],
      [212, 223, 11],
      [199, 211, 10],
      [187, 198, 9],
      [174, 186, 8],
      [162, 173, 7],
      [149, 161, 6],
      [137, 148, 5],
      [124, 136, 4],
      [112, 123, 3],
      [100, 112, 2],
    ],
    C: [
      [80,  99,  0],
      [100, 104, 2],
      [105, 114, 3],
      [115, 124, 4],
      [125, 134, 5],
      [135, 144, 6],
      [145, 154, 7],
      [155, 164, 8],
      [165, 174, 9],
      [175, 184, 10],
      [185, 194, 11],
      [195, 204, 12],
      [205, 214, 13],
      [215, 224, 14],
      [225, 234, 15],
      [235, 244, 16],
      [245, 254, 17],
      [255, 264, 18],
      [265, 274, 19],
      [275, 284, 20],
      [285, 294, 21],
      [295, 304, 22],
      [305, 314, 23],
      [315, 324, 24],
      [325, 334, 25],
      [334, 345, 26],
      [345, 354, 27],
      [355, 364, 28],
      [365, 374, 29],
      [375, 384, 30],
      [385, 390, 31],
    ]
  };

  const upScale = (s) => (s === "A" ? "B" : s === "B" ? "C" : "C");
  const downScale = (s) => (s === "C" ? "B" : s === "B" ? "A" : "A");

  function lookupRate(scale, bg) {
    const rows = TABLE[scale];
    for (const [lo, hi, rate] of rows) {
      if (bg >= lo && bg <= hi) return { rate, lo, hi };
    }
    return null;
  }

  function num(v) {
    const n = Number(String(v).trim());
    return Number.isFinite(n) ? n : null;
  }

  function roundToHalf(x) {
    return Math.round(x * 2) / 2;
  }

  function trend(prev, curr) {
    const d = curr - prev;
    if (d > 0) return `↑ (+${d})`;
    if (d < 0) return `↓ (${d})`;
    return `→ (0)`;
  }

  // ========= RULES =========
  function recommend(currScale, currRate, prevBG, currBG, sameScale) {
    const drop = prevBG - currBG; // positive if BG decreased
    const consecutiveAbove150 = (prevBG > 150 && currBG > 150 && sameScale);
    const consecutiveIn120150 =
      (prevBG >= 120 && prevBG <= 150 && currBG >= 120 && currBG <= 150);

    // BG <70: hypoglycemia protocol
    if (currBG < 70) {
      return {
        mode: "HOLD",
        newScale: "A",
        newRate: 0,
        action: "Immediately stop insulin infusion and initiate hypoglycemia management per protocol. Notify provider.",
        recheck: "Recheck BG every 15 minutes and repeat treatment until BG >70. Follow re-initiation guidance after required waiting period per policy.",
        notes: "This tool does not compute dextrose dosing. Follow institutional hypoglycemia protocol.",
        tableInfo: null,
        overrideUsed: false,
        overrideNote: "",
        notifyNote: ""
      };
    }

    // BG 70–90: hold infusion, force Scale A on restart
    if (currBG >= 70 && currBG < 90) {
      return {
        mode: "HOLD",
        newScale: "A",
        newRate: 0,
        action: "Hold infusion.",
        recheck: "Recheck BG in 30 minutes, then every 1 hour for 4 hours.",
        notes: "Restart insulin drip on Scale A if BG is >150 mg/dL during that time.",
        tableInfo: null,
        overrideUsed: false,
        overrideNote: "",
        notifyNote: ""
      };
    }

    // Choose scale
    let ns = currScale;

    // Priority override: BG <120 -> decrease one scale, then titrate
    if (currBG < 120) ns = downScale(currScale);

    // If BG >150 for 2 consecutive checks on same scale -> increase one scale
    if (currBG > 150 && consecutiveAbove150) ns = upScale(currScale);

    // Rate from table (after scale selection)
    const table = lookupRate(ns, currBG);
    const rateFromTable = table ? table.rate : null;

    // Recheck guidance
    let recheck = "Recheck BG every 1 hour.";
    if (currBG >= 120 && currBG <= 150 && consecutiveIn120150) {
      recheck = "Recheck BG every 1 hour. If 2 consecutive checks remain 120–150, may broaden to every 2 hours per workflow.";
    } else if (currBG >= 120 && currBG <= 150) {
      recheck = "Recheck BG every 1 hour. If 2 consecutive checks are 120–150, may broaden to every 2 hours.";
    }

    // Action text
    let action = "";
    if (currBG >= 120 && currBG <= 150) {
      action = `BG 120–150: titrate within current scale (Scale ${ns}) to match BG range.`;
    } else if (currBG < 120) {
      action = `BG <120: decrease one scale (${currScale} → ${ns}), then titrate within new scale.`;
    } else if (currBG > 150 && consecutiveAbove150 && ns !== currScale) {
      action = `BG >150 for 2 consecutive checks on same scale: increase one scale (${currScale} → ${ns}), then titrate within new scale.`;
    } else if (currBG > 150) {
      action = `BG >150: titrate within current scale (Scale ${ns}).`;
    } else {
      action = "Titrate per protocol.";
    }

    // Big drop safety rule: only applies when currBG >= 120 so it does not override the BG<120 workflow
    let finalRate = rateFromTable;
    let overrideUsed = false;
    let overrideNote = "";
    let notifyNote = "";

    const bigDrop = drop > 100;

    if (bigDrop && currBG >= 120 && currRate !== null) {
      finalRate = roundToHalf(currRate / 2);
      overrideUsed = true;
      overrideNote = `BG decreased >100 mg/dL (${prevBG} → ${currBG}). Halve current infusion rate (${currRate} → ${finalRate} U/hr).`;
      notifyNote = "Notify MD: BG decreased >100 mg/dL and rate was halved.";
    }

    return {
      mode: "RUN",
      newScale: ns,
      newRate: finalRate,
      action,
      recheck,
      notes: table
        ? `Table match: Scale ${ns}, BG ${table.lo}–${table.hi} → ${table.rate} U/hr.`
        : "BG outside configured table; consult provider/protocol.",
      tableInfo: table,
      overrideUsed,
      overrideNote,
      notifyNote
    };
  }

  // ========= UI =========
  const $scale = document.getElementById("scale");
  const $rate = document.getElementById("rate");
  const $prev = document.getElementById("prev");
  const $curr = document.getElementById("curr");
  const $sameScale = document.getElementById("sameScale");
  const $out = document.getElementById("out");

  function show(html) {
    $out.style.display = "block";
    $out.innerHTML = html;
  }

  document.getElementById("calc").addEventListener("click", () => {
    const currScale = $scale.value;
    const currRate = num($rate.value);
    const prevBG = num($prev.value);
    const currBG = num($curr.value);
    const sameScale = $sameScale.checked;

    if (prevBG === null || currBG === null) {
      show(`<p>Please enter valid numbers for previous and current BG.</p>`);
      return;
    }
    if (currRate !== null && currRate < 0) {
      show(`<p>Current infusion rate must be ≥ 0.</p>`);
      return;
    }

    const rec = recommend(currScale, currRate, prevBG, currBG, sameScale);

    // Display status: show "Paused" when calculator is in RUN mode but recommends 0 U/hr (e.g., 80–99)
    const displayStatus = (rec.mode === "RUN" && rec.newRate === 0) ? "Paused" : rec.mode;

    const rateLine = (rec.newRate === null)
      ? `<p><span class="small">Recommended new rate:</span> <span class="mono">Consult protocol/provider</span></p>`
      : `<p><span class="small">Recommended new rate:</span> <span class="mono">${rec.newRate} U/hr</span></p>`;

    show(`
      <p><span class="small">Inputs:</span>
        <span class="mono">Scale ${currScale}</span>,
        <span class="mono">${prevBG} → ${currBG} mg/dL</span>
        <span class="mono">${trend(prevBG, currBG)}</span>
      </p>
      <p><span class="small">Insulin Gtt Status:</span> <span class="mono">${displayStatus}</span></p>
      <p><span class="small">Recommended scale:</span> <span class="mono">Scale ${rec.newScale}</span></p>
      ${rateLine}
      <p><span class="small">Action:</span> <span class="mono">${rec.action}</span></p>
      <p><span class="small">Recheck:</span> <span class="mono">${rec.recheck}</span></p>
      <p class="small">${rec.notes}</p>
      ${rec.overrideUsed ? `<div class="dangerBox"><div class="danger">WARNING</div>${rec.overrideNote}<br/>${rec.notifyNote}</div>` : ``}
    `);
  });

  document.getElementById("reset").addEventListener("click", () => {
    $rate.value = "";
    $prev.value = "";
    $curr.value = "";
    $scale.value = "A";
    $sameScale.checked = true;
    $out.style.display = "none";
    $out.innerHTML = "";
  });
})();
</script>
</body>
</html>


